# TODO App on Rails
## MagmaHackers - Challenge 2

This challenge was set to be completed as a part of the MagmaHackers Program - 2018.

## Setting everything up
Install Rails and postgresql.

After that having that ready, we're gonna need to start a new Rails project.
On your command line let's run `rails new todo --skip-coffee --database=postgresql`
As you can see, we explicitly set the db as postgresql and we skip _coffee_ gem because we do not need it.

## Set log in
To enable different users to use the application, we should implement a log in. For that, we are gonna make use of _devise_, a gem that allows us to do that in a flexible, quick an easy way.

Add `gem 'devise'` to the Gemfile of your project and then make a `bundle install` to apply the new change.

Next step is to run `rails generate devise:install`.

After this, some instructions will show up, although for the required functionality, only adding `config.action_mailer.default_url_options = { host: 'localhost', port: 3000 }` to the _config/environments/development.rb_ file will be necessary.

Don't forget to have the _postgresql_ server running before attempting the next step, so enter `sudo service postgresql start` in the command line to start it if you haven't.

Once you make sure server is on, let's type `rake db:setup` for the db iniatilization.
Some warnings are gonna show up because of the lack of the db schema file but that's normal, we're heading there.

To start the model for the devise feature run `rails generate devise User`.

Then, we are ready to migrate the db with `rake db:migrate` so the generated tables for the models are created.

You can try your project so far and checking everything's working with `rails s` to set the db up and the check our app on _localhost:3000_ to see the default home rails page, or _localhost:3000/users/sign_up_ to see the sign_up page generated by devise.

## Creating models
Next we need to create the models for the todo lists and the tasks, for that, we run: 
⋅⋅⋅**For creating List model:** `rails generate scaffold List title:string user_id:integer`, where _List_ is the model name and _title_ and _user_ are properties of the model (columns in the table).
⋅⋅⋅**For creating Task model:** `rails generate scaffold Task description:text done:boolean list_id:integer`.
And finally, we need to run `rails db:migrate` to update the schema with the new models.

Set the a method to allows users to go to the lists index once they sign in, at _app/controllers/application_controllers.rb_

``` ruby
def after_sign_in_path_for(resource)
  lists_path
end
```

Set `before_action :authenticate_user!` at the beginning of all the controllers so that noone can access those views unless they signed in

Add the corresponding relations among the models:
- `has_many :lists` in the _User_ model
+ `belongs_to :user` and `has_many :tasks` in the _List_ model
* `belongs_to :lists` in the _Task_ model

Change to `@lists = current_user.lists` in the _index_ action of the _lists_controller_ so that the lists brought on the index lists views are only the ones from the user signed in.

Change to `params.require(:list).permit(:title).merge(:user_id => current_user.id)` in the _lists_params_ action of the _lists_controller_.

Add `@tasks = @list.tasks` in the _show_ action of the _lists_controller_ so that the the tasks corresponding to that list are shown in the show view of the lists.

Update to this the _show view_ of the lists
``` html
<h1><%= @list.title %></h1>

<h2>Tasks</h2>

<table>
  <thead>
    <tr>
      <th>Desc</th>
      <th>Status</th>
      <th>TODO Lists</th>
      <th colspan="3"></th>
    </tr>
  </thead>

  <tbody>
    <% @tasks.each do |task| %>
      <tr>
        <td><%= task.description %></td>
        <td><%= task.done %></td>
        <td><%= task.list_id %></td>
        <td><%= link_to 'Show', task %></td>
        <td><%= link_to 'Edit', edit_task_path(task) %></td>
        <td><%= link_to 'Destroy', task, method: :delete, data: { confirm: 'Are you sure?' } %></td>
      </tr>
    <% end %>
  </tbody>
</table>
<br>
<%= link_to 'New Task', new_task_path %>
<br>
```

## Setting the image feature
Run `rails active_storage:install` and add this at the _config/environments/development.rb_

```ruby
# Store files locally.
config.active_storage.service = :local
``` 

Along with defining `has_one_attached :avatar` to the _User_ model

Run `rails generate devise:views` to have the geenerated views by Devise

At the _views/devise/registrations/new_ add
```html
<div class="field">
  <%= f.label :avatar %>
  <%= f.file_field :avatar %>
</div>
```

Add this to the _application_controller.rb_
```ruby
before_action :configure_permitted_parameters, if: :devise_controller?

protected
  def configure_permitted_parameters
    devise_parameter_sanitizer.permit(:sign_up, keys: [:avatar])
    devise_parameter_sanitizer.permit(:account_update, keys: [:avatar])
  end
```

Migrate the new generated tables from active storage: `rails db:migrate`

Add this to the view you want the image in
`<%= image_tag(currrent_user.avatar) %>`

### Resizing picture
Uncomment the Mini_Magick gem or add it in the gemfile `gem 'mini_magick', '~> 4.8'`
Then, run `bundle install`
After that I needed to install _imagemagick_ so the picture could be seen in the new size: `sudo apt install imagemagick-6.q16`, but if you don't have that problem, no need to do it.

Change the image to this: `<%= image_tag current_user.avatar.variant(resize: "500x500") %>`


For the CSV, really simple!: https://gorails.com/episodes/export-to-csv
Add `require 'csv'` before `require 'rails/all'` in _config_application.rb_

Add this in the _lists_controllers_ file, in the _show_ action


## Implementation of CSV Export
``` ruby
# CSV
  respond_to do |format|
    format.html
    format.csv { send_data @tasks.to_csv }
  end
```

And this in the _task_ model
```ruby
# CSV
  def self.to_csv
    attributes = %w{done description}
    CSV.generate(headers: true) do |csv|
      csv << attributes
      all.each do |task|
        csv << task.attributes.values_at(*attributes)
      end
    end
  end
```

Add `<%= link_to 'Export to CSV', {:format => :csv} %>` in the lists _show_ view to enable a link to perform the exportation and open/download the CSV file. 